{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-cog mr-2"></i>
            Customize Dashboard
        </h1>
        <div class="flex space-x-3">
            <button onclick="autoOrganizeDashboard('priority')" class="btn btn-outline-primary">
                <i class="fas fa-sort-amount-down mr-1"></i>
                Auto Organize
            </button>
            <button onclick="resetDashboard()" class="btn btn-outline-secondary">
                <i class="fas fa-undo mr-1"></i>
                Reset to Default
            </button>
            <a href="{{ url_for('views.dashboard') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left mr-1"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Instructions -->
    <div class="alert alert-info mb-4">
        <h5><i class="fas fa-info-circle mr-2"></i>How to customize your dashboard:</h5>
        <ul class="mb-0">
            <li>Drag and drop widgets to reorder them</li>
            <li>Click the eye icon to show/hide widgets</li>
            <li>Use "Auto Organize" to automatically arrange widgets by priority</li>
            <li>Changes are saved automatically</li>
        </ul>
    </div>

    <!-- Widget Configuration -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-puzzle-piece mr-2"></i>
                        Dashboard Widgets
                    </h5>
                </div>
                <div class="card-body">
                    <div id="widget-list" class="sortable-list">
                        {% for widget in widgets %}
                        <div class="widget-item card mb-3" data-widget-id="{{ widget.id }}" data-position="{{ widget.position }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="drag-handle mr-3">
                                            <i class="fas fa-grip-vertical text-muted"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ widget.name }}</h6>
                                            <small class="text-muted">
                                                Size: 
                                                <span class="badge badge-secondary">{{ widget.size }}</span>
                                                Position: {{ widget.position + 1 }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <!-- Size selector -->
                                        <select class="form-control form-control-sm mr-2 widget-size" style="width: 100px;">
                                            <option value="small" {{ 'selected' if widget.size == 'small' else '' }}>Small</option>
                                            <option value="normal" {{ 'selected' if widget.size == 'normal' else '' }}>Normal</option>
                                            <option value="large" {{ 'selected' if widget.size == 'large' else '' }}>Large</option>
                                        </select>
                                        
                                        <!-- Visibility toggle -->
                                        <button class="btn btn-sm visibility-toggle {{ 'btn-success' if widget.is_visible else 'btn-outline-secondary' }}" 
                                                data-visible="{{ 'true' if widget.is_visible else 'false' }}"
                                                title="{{ 'Hide widget' if widget.is_visible else 'Show widget' }}">
                                            <i class="fas {{ 'fa-eye' if widget.is_visible else 'fa-eye-slash' }}"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-sliders-h mr-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button onclick="autoOrganizeDashboard('priority')" class="btn btn-outline-primary">
                            <i class="fas fa-sort-amount-down mr-1"></i>
                            Organize by Priority
                        </button>
                        <button onclick="autoOrganizeDashboard('size')" class="btn btn-outline-secondary">
                            <i class="fas fa-expand-arrows-alt mr-1"></i>
                            Organize by Size
                        </button>
                        <button onclick="showAllWidgets()" class="btn btn-outline-success">
                            <i class="fas fa-eye mr-1"></i>
                            Show All Widgets
                        </button>
                        <button onclick="hideAllWidgets()" class="btn btn-outline-warning">
                            <i class="fas fa-eye-slash mr-1"></i>
                            Hide All Widgets
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-eye mr-2"></i>
                        Widget Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="widget-status">
                        {% set visible_count = widgets|selectattr('is_visible')|list|length %}
                        {% set total_count = widgets|length %}
                        <p class="mb-2">
                            <strong>Visible Widgets:</strong> {{ visible_count }}/{{ total_count }}
                        </p>
                        <div class="progress mb-3">
                            {% set progress_width = (visible_count/total_count*100) if total_count > 0 else 0 %}
                            <div class="progress-bar" role="progressbar" 
                                 style="--progress-width: {{ progress_width }}; width: var(--progress-width, 0%);">
                            </div>
                        </div>
                        <small class="text-muted">
                            Dashboard layout will update automatically when you make changes.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messages" class="position-fixed" style="top: 20px; right: 20px; z-index: 1050;"></div>

<script>
let draggedElement = null;
let originalOrder = [];

// Initialize sortable functionality
document.addEventListener('DOMContentLoaded', function() {
    const sortableList = document.getElementById('widget-list');
    
    // Store original order
    updateOriginalOrder();
    
    // Make list sortable
    if (sortableList) {
        new Sortable(sortableList, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function(evt) {
                updateWidgetPositions();
                saveLayout();
            }
        });
    }
    
    // Add event listeners
    attachEventListeners();
});

function updateOriginalOrder() {
    originalOrder = Array.from(document.querySelectorAll('.widget-item')).map(el => el.dataset.widgetId);
}

function attachEventListeners() {
    // Visibility toggle buttons
    document.querySelectorAll('.visibility-toggle').forEach(button => {
        button.addEventListener('click', function() {
            toggleWidgetVisibility(this);
        });
    });
    
    // Size selectors
    document.querySelectorAll('.widget-size').forEach(select => {
        select.addEventListener('change', function() {
            updateWidgetSize(this);
        });
    });
}

function updateWidgetPositions() {
    const widgets = document.querySelectorAll('.widget-item');
    widgets.forEach((widget, index) => {
        widget.dataset.position = index;
        const positionSpan = widget.querySelector('small');
        if (positionSpan) {
            positionSpan.innerHTML = positionSpan.innerHTML.replace(/Position: \d+/, `Position: ${index + 1}`);
        }
    });
}

function toggleWidgetVisibility(button) {
    const widgetItem = button.closest('.widget-item');
    const widgetId = widgetItem.dataset.widgetId;
    const isVisible = button.dataset.visible === 'true';
    const newVisibility = !isVisible;
    
    // Update button appearance
    button.dataset.visible = newVisibility.toString();
    button.className = `btn btn-sm visibility-toggle ${newVisibility ? 'btn-success' : 'btn-outline-secondary'}`;
    button.innerHTML = `<i class="fas ${newVisibility ? 'fa-eye' : 'fa-eye-slash'}"></i>`;
    button.title = newVisibility ? 'Hide widget' : 'Show widget';
    
    // Update widget appearance
    widgetItem.style.opacity = newVisibility ? '1' : '0.5';
    
    // Save changes
    saveLayout();
    updateWidgetStatus();
}

function updateWidgetSize(select) {
    const widgetItem = select.closest('.widget-item');
    const sizeSpan = widgetItem.querySelector('.badge');
    if (sizeSpan) {
        sizeSpan.textContent = select.value;
    }
    saveLayout();
}

function saveLayout() {
    const widgets = Array.from(document.querySelectorAll('.widget-item')).map((item, index) => ({
        id: item.dataset.widgetId,
        position: index,
        is_visible: item.querySelector('.visibility-toggle').dataset.visible === 'true',
        size: item.querySelector('.widget-size').value
    }));
    
    fetch('/dashboard/api/save-layout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ widgets: widgets })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Layout saved successfully!', 'success');
        } else {
            showMessage('Error saving layout: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error saving layout: ' + error.message, 'error');
    });
}

function autoOrganizeDashboard(method) {
    fetch('/dashboard/api/auto-organize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ method: method })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMessage('Error organizing dashboard: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Error organizing dashboard: ' + error.message, 'error');
    });
}

function resetDashboard() {
    if (confirm('Are you sure you want to reset the dashboard to default layout? This will undo all your customizations.')) {
        fetch('/dashboard/api/reset-layout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showMessage('Error resetting dashboard: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Error resetting dashboard: ' + error.message, 'error');
        });
    }
}

function showAllWidgets() {
    document.querySelectorAll('.visibility-toggle').forEach(button => {
        if (button.dataset.visible === 'false') {
            button.click();
        }
    });
}

function hideAllWidgets() {
    document.querySelectorAll('.visibility-toggle').forEach(button => {
        if (button.dataset.visible === 'true') {
            button.click();
        }
    });
}

function updateWidgetStatus() {
    const visibleCount = document.querySelectorAll('.visibility-toggle[data-visible="true"]').length;
    const totalCount = document.querySelectorAll('.visibility-toggle').length;
    const percentage = totalCount > 0 ? (visibleCount / totalCount * 100) : 0;
    
    const statusDiv = document.getElementById('widget-status');
    statusDiv.innerHTML = `
        <p class="mb-2">
            <strong>Visible Widgets:</strong> ${visibleCount}/${totalCount}
        </p>
        <div class="progress mb-3">
            <div class="progress-bar" role="progressbar" style="width: ${percentage}%"></div>
        </div>
        <small class="text-muted">
            Dashboard layout will update automatically when you make changes.
        </small>
    `;
}

function showMessage(message, type) {
    const messagesDiv = document.getElementById('messages');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const messageEl = document.createElement('div');
    messageEl.className = `alert ${alertClass} alert-dismissible fade show`;
    messageEl.innerHTML = `
        <i class="fas ${icon} mr-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    messagesDiv.appendChild(messageEl);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        if (messageEl.parentNode) {
            messageEl.parentNode.removeChild(messageEl);
        }
    }, 3000);
}
</script>

<!-- Include SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% endblock %}
