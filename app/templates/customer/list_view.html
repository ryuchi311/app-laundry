<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Customers — Directory</title>
  <!-- Tailwind should already be available globally in the project layout -->
</head>
<body class="bg-gray-50 text-gray-800">
  {% extends 'base.html' %}
  {% block title %}Customers{% endblock %}
  {% block content %}
    <div class="max-w-6xl mx-auto p-6">
      <div id="login-banner" class="hidden mb-4 p-4 rounded-md bg-yellow-50 border border-yellow-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"></path></svg>
          <div>
            <div class="font-medium">You're not signed in</div>
            <div class="text-sm text-yellow-700">Sign in to view full customer details and perform actions.</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <a id="login-cta" href="{{ url_for('auth.login') }}" class="inline-flex items-center px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Sign in</a>
          <button id="login-dismiss" class="text-sm text-yellow-700 underline">Dismiss</button>
        </div>
      </div>

      <header class="mb-6">
        <h1 class="text-2xl font-semibold">Customer Directory</h1>
        <p class="text-sm text-gray-600">Search and browse customers (server-side pagination)</p>
      </header>

      <div class="bg-white shadow rounded-lg p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
          <div class="flex items-center gap-2 w-full md:w-1/2">
            <input id="searchInput" type="search" placeholder="Search name..." class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <select id="perPage" class="border rounded px-2 py-2">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <button id="refreshBtn" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Refresh</button>
          </div>

          <div class="flex items-center gap-3 text-sm text-gray-600">
            <div id="resultsInfo">&nbsp;</div>

            {# Add and Export controls (visible when logged in) #}
            {% if current_user.is_authenticated %}
            <div class="flex items-center gap-2 ml-4">
              <a href="{{ url_for('customer.add_customer') }}" class="inline-flex items-center px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                <i class="fas fa-plus mr-2"></i> Add
              </a>
              <button id="exportBtn" data-allowed="{{ 'true' if (current_user.is_admin() or current_user.is_manager()) else 'false' }}" class="inline-flex items-center px-3 py-2 rounded border text-sm hover:bg-gray-200" aria-disabled="{{ 'false' if (current_user.is_admin() or current_user.is_manager()) else 'true' }}">
                <i class="fas fa-file-csv mr-2"></i> Export CSV
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="relative overflow-x-auto">
          <!-- Mobile card list (visible on small screens) -->
          <div id="customersCards" class="md:hidden space-y-3">
            <!-- cards injected here for mobile -->
          </div>

          <!-- Desktop table (hidden on small screens) -->
          <div class="hidden md:block">
            <table class="min-w-full table-auto divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">
                    <div class="flex items-center gap-2">
                      <span>Name</span>
                      <button id="filter-name-btn" title="Filter by name" class="text-gray-400 hover:text-gray-700 focus:outline-none">
                        <!-- small filter icon -->
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 12.414V19a1 1 0 01-1.447.894L9 17H4a1 1 0 01-1-1V4z"/></svg>
                      </button>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Email</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Phone</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">
                    <div class="flex items-center gap-2">
                      <span>Cycle</span>
                      <button id="sort-laundries-btn" title="Sort by cycle" class="text-gray-400 hover:text-gray-700 focus:outline-none">
                        <svg id="sort-laundries-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path id="sort-laundries-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5 5 5M7 19l5-5 5 5"/></svg>
                      </button>
                    </div>
                  </th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Joined</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Status</th>
                </tr>
            </thead>
            <tbody id="customersTbody" class="bg-white divide-y divide-gray-100">
              <!-- rows injected here -->
            </tbody>
          </table>
          </div>

          <!-- Overlay spinner that covers the table while loading -->
          <div id="tableSpinnerOverlay" class="hidden absolute inset-0 bg-white/60 backdrop-blur flex items-center justify-center z-10">
            <div class="flex flex-col items-center gap-3">
              <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
              <div class="text-sm text-gray-700">Loading customers…</div>
            </div>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div id="loading" class="hidden items-center gap-2 text-sm text-gray-500">
            <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
            Loading...
          </div>

          <nav id="pagination" class="inline-flex items-center space-x-2" aria-label="Pagination">
            <!-- numeric pagination rendered here -->
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Confirmation Modal -->
  <div id="exportConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full mx-4 p-6">
      <h3 class="text-lg font-semibold mb-2">Confirm Export</h3>
      <p class="text-sm text-gray-600 mb-4">You're about to export the customer list to CSV. This may include all matching records. Do you want to continue?</p>
      <div class="flex justify-end gap-3">
        <button id="exportCancel" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200">Cancel</button>
        <button id="exportConfirm" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Export</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const apiUrl = '/api/customers';
      const searchInput = document.getElementById('searchInput');
      const perPageSelect = document.getElementById('perPage');
      const customersTbody = document.getElementById('customersTbody');
      const loadingEl = document.getElementById('loading');
      const paginationEl = document.getElementById('pagination');
      const resultsInfo = document.getElementById('resultsInfo');
      const loginBanner = document.getElementById('login-banner');
      const loginDismiss = document.getElementById('login-dismiss');
      const loginCta = document.getElementById('login-cta');
      const exportBtn = document.getElementById('exportBtn');
      const exportModal = document.getElementById('exportConfirmModal');
      const exportConfirm = document.getElementById('exportConfirm');
      const exportCancel = document.getElementById('exportCancel');

  let page = 1;
  let perPage = parseInt(perPageSelect.value, 10) || 25;
      let pages = 1;
      let total = 0;
      let lastSearch = '';
  let sortBy = 'date_created';
  let sortOrder = 'desc';
      let searchTimer = null;

      const tableSpinner = document.getElementById('tableSpinnerOverlay');
      const controls = [searchInput, perPageSelect, document.getElementById('refreshBtn')];

      function setControlsDisabled(disabled) {
        for (const el of controls) {
          if (!el) continue;
          el.disabled = disabled;
          el.classList.toggle('opacity-60', disabled);
          el.classList.toggle('cursor-not-allowed', disabled);
        }
      }

      function showLoading(show) {
        loadingEl.classList.toggle('hidden', !show);
        if (tableSpinner) tableSpinner.classList.toggle('hidden', !show);
        setControlsDisabled(show);
      }

      function showLoginBanner(show) {
        if (show) {
          loginBanner.classList.remove('hidden');
        } else {
          loginBanner.classList.add('hidden');
        }
      }

      loginDismiss.addEventListener('click', () => showLoginBanner(false));

      // If user clicks CTA, go to login page (server-side route)
      loginCta.addEventListener('click', (e) => {
        // allow default anchor behavior
      });

      // Export handler builds current filter params into export URL
      if (exportBtn) {
        exportBtn.addEventListener('click', (e) => {
          const allowed = exportBtn.getAttribute('data-allowed') === 'true';
          const q = (searchInput.value || '').trim();
          const params = new URLSearchParams();
          if (q) params.set('search', q);

          const url = '/customer/export' + (params.toString() ? ('?' + params.toString()) : '');

          if (!allowed) {
            // Small permission notice for non-authorized users
            // Use a lightweight alert to avoid extra UI plumbing
            alert('Export is restricted to Managers and Admins. Please request permission if you need this feature.');
            return;
          }

          // Show confirmation modal
          exportModal.classList.remove('hidden');

          exportConfirm.onclick = function() {
            // open export URL in a new tab to trigger download
            window.open(url, '_blank');
            exportModal.classList.add('hidden');
          };

          exportCancel.onclick = function() {
            exportModal.classList.add('hidden');
          };
        });
      }

      function renderCustomers(items) {
        customersTbody.innerHTML = '';
        const cardsContainer = document.getElementById('customersCards');
        if (cardsContainer) cardsContainer.innerHTML = '';
        if (!items || items.length === 0) {
          // desktop
          customersTbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500">No customers found.</td></tr>';
          // mobile
          if (cardsContainer) cardsContainer.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">No customers found.</div>';
          return;
        }
        const frag = document.createDocumentFragment();
        const cardsFrag = document.createDocumentFragment();
        for (const c of items) {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          // Make the row keyboard-focusable and look clickable
          tr.setAttribute('role', 'link');
          tr.setAttribute('tabindex', '0');
          tr.style.cursor = 'pointer';

          const laundriesCount = Number(c.laundries_count || 0);
          const laundriesLink = `<a href="/laundry/list?customer_id=${encodeURIComponent(c.id)}" class="text-indigo-600 hover:underline">${laundriesCount.toLocaleString()}</a>`;
          tr.innerHTML = `
            <td class="px-4 py-3 text-sm">${escapeHtml(c.full_name || '')}</td>
            <td class="px-4 py-3 text-sm">${escapeHtml(c.email || '')}</td>
            <td class="px-4 py-3 text-sm">${escapeHtml(c.phone || '')}</td>
            <td class="px-4 py-3 text-sm">${laundriesLink}</td>
            <td class="px-4 py-3 text-sm">${escapeHtml(c.date_created || '')}</td>
            <td class="px-4 py-3 text-sm">${c.is_active ? '<span class="text-green-600">Active</span>' : '<span class="text-gray-500">Inactive</span>'}</td>
          `;

          // Row click navigates to the customer view
          tr.addEventListener('click', () => {
            window.location.href = '/customer/view/' + encodeURIComponent(c.id);
          });

          // Support keyboard navigation (Enter to open)
          tr.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' || ev.key === ' ') {
              ev.preventDefault();
              window.location.href = '/customer/view/' + encodeURIComponent(c.id);
            }
          });

          // Prevent clicks on inner links/buttons from triggering the row navigation
          const innerLinks = tr.querySelectorAll('a, button');
          innerLinks.forEach(el => el.addEventListener('click', (e) => e.stopPropagation()));

          frag.appendChild(tr);

          // Mobile card
          if (cardsContainer) {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow';
            card.innerHTML = `
              <div class="flex items-start justify-between">
                <div>
                  <div class="font-medium text-gray-900">${escapeHtml(c.full_name || '')}</div>
                  <div class="text-sm text-gray-500">${escapeHtml(c.email || '')}</div>
                </div>
                <div class="text-right text-sm">
                  ${c.is_active ? '<span class="text-green-600">Active</span>' : '<span class="text-gray-500">Inactive</span>'}
                </div>
              </div>
              <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
                <div>${escapeHtml(c.phone || '')}</div>
                <div class="flex items-center gap-2">
                  <a href="/customer/view/${encodeURIComponent(c.id)}" class="text-indigo-600 hover:underline">View</a>
                  <a href="/customer/edit/${encodeURIComponent(c.id)}" class="text-gray-600 hover:underline">Edit</a>
                </div>
              </div>
            `;
            card.addEventListener('click', () => { window.location.href = '/customer/view/' + encodeURIComponent(c.id); });
            cardsFrag.appendChild(card);
          }
        }
        customersTbody.appendChild(frag);
        if (cardsContainer) cardsContainer.appendChild(cardsFrag);
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>\"']/g, function (s) {
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[s];
        });
      }

      function renderPagination(pagesCount, current) {
        paginationEl.innerHTML = '';
        pages = pagesCount || 1;
        if (pages <= 1) return;

        const createBtn = (text, disabled, cls, onClick) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = `px-3 py-1 rounded text-sm border ${cls}`;
          if (disabled) { b.disabled = true; b.classList.add('opacity-50', 'cursor-not-allowed'); }
          b.innerText = text;
          b.addEventListener('click', onClick);
          return b;
        };

        // First
        paginationEl.appendChild(createBtn('«', current === 1, 'bg-white hover:bg-gray-100', () => goToPage(1)));
        // Prev
        paginationEl.appendChild(createBtn('‹', current === 1, 'bg-white hover:bg-gray-100', () => goToPage(Math.max(1, current - 1))));

        const windowSize = 5; // number of numeric links to show
        let start = Math.max(1, current - Math.floor(windowSize / 2));
        let end = start + windowSize - 1;
        if (end > pages) { end = pages; start = Math.max(1, end - windowSize + 1); }

        if (start > 1) {
          // show first page and ellipsis
          const p1 = createBtn('1', false, 'bg-white hover:bg-gray-100', () => goToPage(1));
          paginationEl.appendChild(p1);
          if (start > 2) {
            const ell = document.createElement('span'); ell.className = 'px-2 text-sm text-gray-500'; ell.innerText = '…'; paginationEl.appendChild(ell);
          }
        }

        for (let i = start; i <= end; i++) {
          const isActive = i === current;
          const cls = isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-gray-100';
          const btn = createBtn(String(i), false, cls, () => goToPage(i));
          if (isActive) btn.classList.add('font-medium');
          paginationEl.appendChild(btn);
        }

        if (end < pages) {
          if (end < pages - 1) {
            const ell = document.createElement('span'); ell.className = 'px-2 text-sm text-gray-500'; ell.innerText = '…'; paginationEl.appendChild(ell);
          }
          const last = createBtn(String(pages), false, 'bg-white hover:bg-gray-100', () => goToPage(pages));
          paginationEl.appendChild(last);
        }

        // Next
        paginationEl.appendChild(createBtn('›', current === pages, 'bg-white hover:bg-gray-100', () => goToPage(Math.min(pages, current + 1))));
        // Last
        paginationEl.appendChild(createBtn('»', current === pages, 'bg-white hover:bg-gray-100', () => goToPage(pages)));
      }

      function updateResultsInfo() {
        resultsInfo.innerText = `Page ${page} of ${pages} — ${total.toLocaleString()} results`;
      }

      async function fetchCustomers(p = 1, showLoader = true) {
        page = p;
        perPage = parseInt(perPageSelect.value, 10) || 25;
        const q = (searchInput.value || '').trim();
        lastSearch = q;
        const params = new URLSearchParams({ page: String(page), per_page: String(perPage), search: q });
        if (sortBy) params.set('sort_by', sortBy);
        if (sortOrder) params.set('sort_order', sortOrder);
        const url = `${apiUrl}?${params.toString()}`;

        try {
          if (showLoader) showLoading(true);
          const resp = await fetch(url, { credentials: 'same-origin' });

          if (resp.status === 401) {
            // Show friendly login CTA instead of failing silently
            showLoginBanner(true);
            renderCustomers([]);
            paginationEl.innerHTML = '';
            resultsInfo.innerText = '';
            return;
          }

          if (!resp.ok) {
            const text = await resp.text();
            console.error('Failed to load customers', resp.status, text);
            renderCustomers([]);
            paginationEl.innerHTML = '';
            resultsInfo.innerText = 'Unable to load customers';
            return;
          }

          const data = await resp.json();
          total = data.total || 0;
          pages = data.pages || 1;
          renderCustomers(data.results || []);
          renderPagination(pages, data.page || page);
          updateResultsInfo();

        } catch (err) {
          console.error('Network error', err);
          resultsInfo.innerText = 'Network error';
          renderCustomers([]);
          paginationEl.innerHTML = '';
        } finally {
          if (showLoader) showLoading(false);
        }
      }

      function goToPage(n) {
        if (n === page) return;
        fetchCustomers(n);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Debounce search
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => fetchCustomers(1), 400);
      });

      // Name filter button opens a small prompt to set the search input
      const filterNameBtn = document.getElementById('filter-name-btn');
      if (filterNameBtn) {
        filterNameBtn.addEventListener('click', () => {
          const val = prompt('Filter customers by name (partial matches):', searchInput.value || '');
          if (val === null) return; // cancelled
          searchInput.value = val;
          fetchCustomers(1);
        });
      }

      // Sort laundries_count toggle
      const sortLaundriesBtn = document.getElementById('sort-laundries-btn');
      const sortLaundriesIcon = document.getElementById('sort-laundries-icon');
      if (sortLaundriesBtn) {
        sortLaundriesBtn.addEventListener('click', () => {
          if (sortBy === 'laundries_count') {
            // toggle order
            sortOrder = (sortOrder === 'desc') ? 'asc' : 'desc';
          } else {
            sortBy = 'laundries_count';
            sortOrder = 'desc';
          }
          // Update icon rotation to reflect order (simple visual cue)
          if (sortOrder === 'asc') {
            sortLaundriesIcon.style.transform = 'rotate(180deg)';
          } else {
            sortLaundriesIcon.style.transform = 'rotate(0deg)';
          }
          fetchCustomers(1);
        });
      }

      perPageSelect.addEventListener('change', () => fetchCustomers(1));
      document.getElementById('refreshBtn').addEventListener('click', () => fetchCustomers(page));

      // Initial load
      fetchCustomers(1, true);

      // Expose for debugging
      window._customerList = { fetchCustomers };
    })();
  </script>
  {% endblock %}
</body>
</html>
