{% extends "base.html" %}

{% block title %}Customer Details & Directory{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
	<div class="max-w-4xl mx-auto px-4 py-6">
		<!-- Customer Details Card (compact) -->
		<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
			<h2 class="text-lg font-semibold text-blue-700 mb-1">Customer Details</h2>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
				<div class="flex items-center gap-3">
					<div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-sm">
						<i class="fas fa-user text-white text-xl"></i>
					</div>
					<div>
						<h3 class="text-sm font-semibold text-gray-900">{{ customer.full_name }}</h3>
						<p class="text-xs text-gray-600">{{ customer.email or 'N/A' }} · {{ customer.phone or 'N/A' }}</p>
						<p class="text-gray-400 text-xs">Joined {{ customer.date_created.strftime('%b %d, %Y') if customer.date_created else '—' }}</p>
						<span class="inline-block mt-1 px-2 py-0.5 rounded-full text-[11px] font-medium {% if customer.is_active %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
							{% if customer.is_active %}Active{% else %}Inactive{% endif %}
						</span>
					</div>
				</div>

				<div class="col-span-1 md:col-span-1 flex flex-col gap-2">
					<div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded text-sm">
						<div>
							<div class="text-xs text-gray-500">Total</div>
							<div class="text-base font-semibold text-gray-900">{{ total_laundries or 0 }}</div>
						</div>
						<div class="text-right">
							<div class="text-xs text-gray-500">Tier</div>
							<div class="text-xs font-semibold text-indigo-700">{{ loyalty.current_tier if loyalty else 'Bronze' }}</div>
						</div>
					</div>
					<div class="flex items-center gap-2 text-xs">
						<div class="px-2 py-1 bg-gray-100 rounded text-center">
							<div class="text-[10px] text-gray-500">Earned (pts)</div>
							<div class="text-sm font-semibold text-gray-900">{{ total_earned or 0 }} pts</div>
						</div>
						{% if show_points %}
						<div class="px-2 py-1 bg-gray-100 rounded text-center">
							<div class="text-[10px] text-gray-500">Pts Today</div>
							<div class="text-sm font-semibold text-gray-900">{{ total_points_today or 0 }}</div>
						</div>
						<div class="px-2 py-1 bg-gray-100 rounded text-center">
							<div class="text-[10px] text-gray-500">Redeemed</div>
							<div class="text-sm font-semibold text-gray-900">{{ total_points_redeemed or 0 }}</div>
						</div>
						<button id="txn-toggle" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">Transactions</button>
						{% else %}
						<div class="px-2 py-1 bg-gray-100 rounded text-center">
							<div class="text-[10px] text-gray-500">Points</div>
							<div class="text-sm font-semibold text-gray-700">Hidden</div>
						</div>
						{% endif %}
					</div>
					<div class="flex items-center gap-2 text-xs">
						<a href="tel:{{ customer.phone }}" class="inline-flex items-center px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700"><i class="fas fa-phone mr-1"></i> Call</a>
						<a href="sms:{{ customer.phone }}" class="inline-flex items-center px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600"><i class="fas fa-sms mr-1"></i> SMS</a>
						{% if customer.email %}
						<a href="mailto:{{ customer.email }}" class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-800 rounded hover:bg-gray-200"><i class="fas fa-envelope mr-1"></i> Email</a>
						{% endif %}
					</div>
				</div>

				<div class="flex justify-end md:justify-center">
					<a href="{{ url_for('customer.edit_customer', id=customer.id) }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg shadow transition-all duration-200">
						<i class="fas fa-edit mr-2"></i> Edit Customer
					</a>
				</div>
			</div>
		</div>

		<!-- Live Directory -->
		<div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6">
			<div id="customer-directory" class="grid grid-cols-1 md:grid-cols-2 gap-6">
				{% for c in customers %}
				<div class="customer-row bg-white rounded-xl shadow border border-gray-200 p-5 flex flex-col gap-2"
					data-name="{{ c.full_name|lower }}" data-email="{{ c.email|lower if c.email else '' }}" data-phone="{{ c.phone|lower if c.phone else '' }}">
					<div class="flex items-center gap-3">
						<div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
							<i class="fas fa-user text-blue-600"></i>
						</div>
						<div>
							<span class="font-bold text-gray-900">{{ c.full_name }}</span>
							{% if not c.is_active %}<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">Inactive</span>{% endif %}
						</div>
					</div>
					<div class="text-sm text-gray-600">Email: {{ c.email or 'N/A' }}</div>
					<div class="text-sm text-gray-600">Phone: {{ c.phone or 'N/A' }}</div>
				</div>
				{% endfor %}
			</div>
		</div>
		</div>

		<!-- Paginated Laundries -->
		<div class="max-w-4xl mx-auto px-6">
			<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3">
				<h3 class="text-sm font-medium mb-3">Laundries <span class="text-xs text-gray-500">(Total: {{ total_laundries or 0 }})</span></h3>
				{% if laundries and laundries|length > 0 %}
				<table class="min-w-full divide-y divide-gray-200 text-xs">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-2 py-1 text-left font-medium text-gray-700">#</th>
							<th class="px-2 py-1 text-left font-medium text-gray-700">Svc</th>
							<th class="px-2 py-1 text-left font-medium text-gray-700">Price</th>
							<th class="px-2 py-1 text-left font-medium text-gray-700">Status</th>
							<th class="px-2 py-1 text-left font-medium text-gray-700">When</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-100">
						{% for l in laundries %}
						<tr class="hover:bg-gray-50">
							<td class="px-2 py-1"><a href="{{ url_for('laundry.edit_laundry', laundry_id=(l.laundry_id or l.id)) }}" class="text-indigo-600 hover:underline">{{ l.laundry_id or l.id }}</a></td>
							<td class="px-2 py-1">{{ l.get_service_name() }}</td>
							<td class="px-2 py-1">{{ '₱{:,.2f}'.format(l.price or 0) }}</td>
							<td class="px-2 py-1">{{ l.status or '—' }}</td>
							<td class="px-2 py-1">{{ l.date_received.strftime('%b %d') if l.date_received else '—' }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>

				<!-- Compact pagination -->
				<div class="mt-3 flex items-center justify-between text-xs">
					<div class="text-gray-600">Page {{ laundries_page.page }} / {{ laundries_page.pages }} · {{ laundries|length }} items</div>
					<div class="flex items-center space-x-1">
						{% set current_page = laundries_page.page %}
						{% set total_pages = laundries_page.pages if laundries_page.pages else 1 %}
						{% set start = (current_page - 2) if (current_page - 2) > 1 else 1 %}
						{% set end = (current_page + 2) if (current_page + 2) < total_pages else total_pages %}
						{% if laundries_page.page > 1 %}
						<a href="?page={{ laundries_page.page - 1 }}&per_page={{ laundries_page.per_page }}" class="px-2 py-0.5 bg-gray-100 rounded">‹</a>
						{% endif %}
						{% for p in range(start, end + 1) %}
							{% if p == laundries_page.page %}
							<span class="px-2 py-0.5 bg-blue-600 text-white rounded">{{ p }}</span>
							{% else %}
							<a href="?page={{ p }}&per_page={{ laundries_page.per_page }}" class="px-2 py-0.5 bg-gray-100 rounded">{{ p }}</a>
							{% endif %}
						{% endfor %}
						{% if laundries_page.page < laundries_page.pages %}
						<a href="?page={{ laundries_page.page + 1 }}&per_page={{ laundries_page.per_page }}" class="px-2 py-0.5 bg-gray-100 rounded">›</a>
						{% endif %}
					</div>
				</div>
			</div>
				{% else %}
				<p class="text-sm text-gray-500">No laundries for this customer.</p>
				{% endif %}
			</div>
		</div>
</div>
<script>
// No live search on this page - directory is static for customer view
</script>
{% if show_points %}
<div id="txn-panel" class="fixed bottom-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg w-80 p-3 hidden">
	<div class="flex items-center justify-between mb-2">
		<div class="font-semibold text-sm">Recent Loyalty Transactions</div>
		<button id="txn-close" class="text-xs text-gray-500">Close</button>
	</div>
	<div class="text-xs text-gray-600 max-h-60 overflow-y-auto">
		{% if recent_transactions and recent_transactions|length > 0 %}
		<ul>
			{% for t in recent_transactions %}
			<li class="py-2 border-b border-gray-100">
				<div class="flex justify-between">
					<div>{{ t.transaction_type }} · {{ t.points }} pts</div>
					<div class="text-gray-400">{{ t.created_at.strftime('%b %d %H:%M') }}</div>
				</div>
				{% if t.description %}<div class="text-xs text-gray-500">{{ t.description }}</div>{% endif %}
			</li>
			{% endfor %}
		</ul>
		{% else %}
		<div class="py-4 text-center text-gray-500">No recent transactions</div>
		{% endif %}
	</div>
</div>
<script>
// Delegated click handler so toggle works regardless of DOM timing or minor markup changes
document.addEventListener('click', function (e) {
	var panel = document.getElementById('txn-panel');
	if (!panel) return;

	var toggle = e.target && (e.target.id === 'txn-toggle' || e.target.closest('#txn-toggle'));
	var close = e.target && (e.target.id === 'txn-close' || e.target.closest('#txn-close'));

	if (toggle) {
		panel.classList.toggle('hidden');
	}
	if (close) {
		panel.classList.add('hidden');
	}
});
</script>
{% endif %}
{% endblock %}
