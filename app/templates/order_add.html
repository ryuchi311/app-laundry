{% extends "base.html" %}

{% block title %}Create New Order{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
    <div class="max-w-4xl mx-auto px-6 py-8">
        
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-700 rounded-2xl shadow-xl p-8 mb-8 relative overflow-hidden">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-10">
                <div class="absolute inset-0" style="background-image: radial-gradient(circle, rgba(255,255,255,0.1) 2px, transparent 2px); background-size: 60px 60px;"></div>
            </div>
            
            <div class="relative flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                        <i class="fas fa-plus-circle text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Create New Order</h1>
                        <p class="text-green-100 flex items-center">
                            <i class="fas fa-clipboard-list mr-2"></i>
                            Add a new laundry order for customer service
                        </p>
                    </div>
                </div>
                
                <a href="{{ url_for('order.list_orders') }}" 
                   class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 hover:shadow-lg transform hover:-translate-y-1 flex items-center space-x-2">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Orders</span>
                </a>
            </div>
        </div>

        <!-- Order Form -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-white/20 overflow-hidden">
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-8 py-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-edit mr-3"></i>
                    Order Details
                </h2>
                <p class="text-gray-300 mt-1">Fill in the information below to create a new order</p>
            </div>
            
            <div class="p-8">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <div class="mb-6">
                            {% for message in messages %}
                                <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl text-sm flex items-center">
                                    <i class="fas fa-exclamation-circle mr-3"></i>{{ message }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form method="POST" class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Customer Selection -->
                        <div class="lg:col-span-2">
                            <label for="customerId" class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-user mr-2 text-green-600"></i>Select Customer
                            </label>
                            <select id="customerId" name="customerId" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white/70 backdrop-blur-sm">
                                <option value="">Choose a customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.phone }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Item Count -->
                        <div>
                            <label for="itemCount" class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-tshirt mr-2 text-blue-600"></i>Number of Items
                            </label>
                            <input type="number" id="itemCount" name="itemCount" required min="1" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white/70 backdrop-blur-sm"
                                   placeholder="e.g., 5">
                        </div>

                        <!-- Service Type -->
                        <div>
                            <label for="serviceType" class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-cog mr-2 text-purple-600"></i>Service Type
                            </label>
                            <select id="serviceType" name="serviceType" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white/70 backdrop-blur-sm"
                                    onchange="updatePricing()">>
                                <option value="">Choose service type...</option>
                                {% for service in services %}
                                {% if service.is_active %}
                                <option value="{{ service.id }}" 
                                        data-base-price="{{ service.base_price }}" 
                                        data-price-per-kg="{{ service.price_per_kg }}"
                                        data-estimated-hours="{{ service.estimated_hours }}">
                                    {{ service.name }} - ₱{{ "%.2f"|format(service.base_price) }}
                                    {% if service.price_per_kg > 0 %} + ₱{{ "%.2f"|format(service.price_per_kg) }}/kg{% endif %}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Weight -->
                    <div>
                        <label for="weight_kg" class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-weight mr-2 text-purple-600"></i>Weight (kg) <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="weight_kg" name="weight_kg" step="0.1" min="0.1" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white/70 backdrop-blur-sm"
                               placeholder="Enter weight in kilograms"
                               onchange="updatePricing()">
                        <div class="mt-2 text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            Weight will be used to calculate total price for services with per-kg pricing
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-semibold text-gray-700 mb-3">
                            <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>Additional Notes
                        </label>
                        <textarea id="notes" name="notes" rows="4" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 bg-white/70 backdrop-blur-sm resize-none"
                                  placeholder="Any special instructions or notes about this order..."></textarea>
                    </div>

                    <!-- Pricing Information -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-calculator mr-3 text-blue-600"></i>
                            Pricing Information
                        </h3>
                        
                        <!-- Service Details Card -->
                        <div id="serviceDetailsCard" class="bg-white rounded-lg p-6 border border-blue-200 mb-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-sm text-gray-600 mb-1">Base Price</div>
                                    <div id="basePriceDisplay" class="text-xl font-bold text-blue-600">₱0.00</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-600 mb-1">Per Kilogram</div>
                                    <div id="perKgPriceDisplay" class="text-xl font-bold text-purple-600">₱0.00</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="text-center">
                                    <div class="text-sm text-gray-600 mb-1">Estimated Time</div>
                                    <div id="estimatedTimeDisplay" class="text-lg font-medium text-indigo-600 flex items-center justify-center">
                                        <i class="fas fa-clock mr-2"></i>
                                        <span>0 hours</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Price Card -->
                        <div class="bg-white rounded-lg p-6 border border-blue-200">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 mb-2">Total Order Price</div>
                                <div id="totalPriceDisplay" class="text-3xl font-bold text-green-600">₱0.00</div>
                                <div id="priceBreakdown" class="text-xs text-gray-500 mt-2 hidden">
                                    <div>Base Price: <span id="baseAmount">₱0.00</span></div>
                                    <div>Weight Cost: <span id="weightAmount">₱0.00</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                                <div>
                                    <h5 class="font-medium text-yellow-800">Pricing Note</h5>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        Price is calculated as: Base Price + (Price per kg × Weight). Select a service and enter weight to see the total.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                        <a href="{{ url_for('order.list_orders') }}" 
                           class="inline-flex items-center space-x-2 px-6 py-3 border border-gray-300 text-gray-700 bg-white rounded-xl hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200">
                            <i class="fas fa-times"></i>
                            <span>Cancel</span>
                        </a>
                        
                        <button type="submit" 
                                class="inline-flex items-center space-x-2 px-8 py-3 border border-transparent text-white bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Order</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bottom Spacing -->
    <div class="h-16"></div>
</div>

<script>
// Form enhancement and validation
document.addEventListener('DOMContentLoaded', function() {
    const serviceTypeSelect = document.getElementById('serviceType');
    const form = document.querySelector('form');
    const submitButton = form.querySelector('button[type="submit"]');
    const customerSelect = document.getElementById('customerId');
    const itemCountInput = document.getElementById('itemCount');
    
    // Service type selection highlighting and pricing update
    serviceTypeSelect.addEventListener('change', function() {
        const selectedService = this.value;
        
        // Update pricing when service changes
        updatePricing();
        
        // Validate form
        validateForm();
    });
    
    // Form validation
    function validateForm() {
        const customer = customerSelect.value;
        const itemCount = itemCountInput.value;
        const serviceType = serviceTypeSelect.value;
        const weight = document.getElementById('weight_kg').value;
        
        const isValid = customer && itemCount && serviceType && weight && 
                       parseInt(itemCount) > 0 && parseFloat(weight) > 0;
        
        if (isValid) {
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    // Update pricing based on service and weight
    window.updatePricing = function() {
        const serviceSelect = document.getElementById('serviceType');
        const weightInput = document.getElementById('weight_kg');
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        
        // Get all display elements
        const serviceDetailsCard = document.getElementById('serviceDetailsCard');
        const basePriceDisplay = document.getElementById('basePriceDisplay');
        const perKgPriceDisplay = document.getElementById('perKgPriceDisplay');
        const estimatedTimeDisplay = document.getElementById('estimatedTimeDisplay');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const priceBreakdown = document.getElementById('priceBreakdown');
        const baseAmount = document.getElementById('baseAmount');
        const weightAmount = document.getElementById('weightAmount');
        
        if (!selectedOption || !selectedOption.value) {
            // Hide service details if no service selected
            if (serviceDetailsCard) serviceDetailsCard.classList.add('hidden');
            if (priceBreakdown) priceBreakdown.classList.add('hidden');
            if (totalPriceDisplay) totalPriceDisplay.textContent = '₱0.00';
            return;
        }
        
        const basePrice = parseFloat(selectedOption.dataset.basePrice) || 0;
        const pricePerKg = parseFloat(selectedOption.dataset.pricePerKg) || 0;
        const estimatedHours = parseFloat(selectedOption.dataset.estimatedHours) || 0;
        const weight = parseFloat(weightInput.value) || 0;
        const serviceName = selectedOption.textContent;
        const isPremium = serviceName.toLowerCase().includes('premium') || serviceName.toLowerCase().includes('fold') || serviceName.toLowerCase().includes('full service');
        
        // Show service details card
        if (serviceDetailsCard) serviceDetailsCard.classList.remove('hidden');
        
        // Update service details with Premium styling
        if (basePriceDisplay) {
            basePriceDisplay.textContent = '₱' + basePrice.toFixed(2);
            basePriceDisplay.className = isPremium ? 'text-xl font-bold text-yellow-600' : 'text-xl font-bold text-blue-600';
        }
        if (perKgPriceDisplay) {
            perKgPriceDisplay.textContent = '₱' + pricePerKg.toFixed(2);
            perKgPriceDisplay.className = isPremium ? 'text-xl font-bold text-yellow-600' : 'text-xl font-bold text-purple-600';
        }
        if (estimatedTimeDisplay) {
            const timeText = estimatedHours === 1 ? '1 hour' : estimatedHours + ' hours';
            estimatedTimeDisplay.querySelector('span').textContent = timeText;
            estimatedTimeDisplay.className = isPremium ? 'text-lg font-medium text-yellow-600 flex items-center justify-center' : 'text-lg font-medium text-indigo-600 flex items-center justify-center';
        }
        
        // Calculate and display total price
        const weightCost = pricePerKg * weight;
        const totalPrice = basePrice + weightCost;
        
        if (totalPriceDisplay) {
            totalPriceDisplay.textContent = '₱' + totalPrice.toFixed(2);
            if (isPremium) {
                totalPriceDisplay.className = 'text-3xl font-bold text-yellow-600';
                // Add crown icon for premium
                if (!totalPriceDisplay.querySelector('.fa-crown')) {
                    const crown = document.createElement('i');
                    crown.className = 'fas fa-crown text-yellow-500 ml-2';
                    totalPriceDisplay.appendChild(crown);
                }
            } else {
                totalPriceDisplay.className = 'text-3xl font-bold text-green-600';
                // Remove crown if exists
                const crown = totalPriceDisplay.querySelector('.fa-crown');
                if (crown) crown.remove();
            }
        }
        
        // Show price breakdown if weight is entered
        if (weight > 0 && priceBreakdown) {
            priceBreakdown.classList.remove('hidden');
            if (baseAmount) baseAmount.textContent = '₱' + basePrice.toFixed(2);
            if (weightAmount) weightAmount.textContent = '₱' + weightCost.toFixed(2);
        } else if (priceBreakdown) {
            priceBreakdown.classList.add('hidden');
        }
        
        validateForm();
    };
    
    // Add event listeners for real-time validation
    [customerSelect, itemCountInput, serviceTypeSelect, document.getElementById('weight_kg')].forEach(function(element) {
        element.addEventListener('change', validateForm);
        element.addEventListener('input', validateForm);
    });
    
    // Initial validation
    validateForm();
    
    // Add form field animations
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(function(field) {
        field.addEventListener('focus', function() {
            this.style.transform = 'scale(1.02)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        field.addEventListener('blur', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Form submission enhancement
    form.addEventListener('submit', function() {
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Order...';
        submitButton.disabled = true;
    });
});
</script>

{% endblock %}
