{% extends "base.html" %}

{% block title %}Audit Trail - Laundry #{{ laundry.laundry_id }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Audit Trail</h1>
                <p class="text-gray-600">Laundry #{{ laundry.laundry_id }} - {{ laundry.customer.name }}</p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('laundry.edit_laundry', laundry_id=laundry.laundry_id) }}" 
                   class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md">
                    Edit Laundry
                </a>
                <a href="{{ url_for('laundry.print_receipt', laundry_id=laundry.laundry_id) }}" 
                   target="_blank"
                   class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                    Print Receipt
                </a>
                <a href="{{ url_for('laundry.list_laundries') }}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                    Back to Orders
                </a>
            </div>
        </div>
    </div>

    <!-- Laundry Summary -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Laundry Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <dt class="text-sm font-medium text-gray-500">Status</dt>
                <dd class="mt-1">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                        {% if laundry.status == 'Completed' %}bg-green-100 text-green-800
                        {% elif laundry.status == 'Ready for Pickup' %}bg-blue-100 text-blue-800
                        {% elif laundry.status == 'In Process' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ laundry.status }}
                    </span>
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Service Type</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ laundry.service_type or 'Not specified' }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Item Count</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ laundry.item_count or 0 }} items</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Received Date</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ laundry.date_received.strftime('%Y-%m-%d') }}</dd>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
                <dt class="text-sm font-medium text-gray-500">Edit Count</dt>
                <dd class="mt-1 text-sm text-gray-900">
                    {{ laundry.edit_count or 0 }} times
                    {% if laundry.is_modified %}
                    <span class="text-orange-600">‚ö†Ô∏è Modified</span>
                    {% endif %}
                </dd>
            </div>
        {% if laundry.last_edited_by %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
                Last edited by: <span class="font-medium">{{ laundry.last_edited_by }}</span>
                on {{ laundry.last_edited_at.strftime('%Y-%m-%d %H:%M:%S') if laundry.last_edited_at else 'Unknown' }}
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Audit Log -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Change History</h2>
            <p class="text-sm text-gray-600">Complete audit trail of all changes made to this laundry</p>
        </div>
        
        {% if audit_logs %}
        <div class="overflow-hidden">
            <div class="max-h-96 overflow-y-auto">
                <ul class="divide-y divide-gray-200">
                    {% for log in audit_logs %}
                    <li class="p-6">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center
                                    {% if log.action == 'CREATED' %}bg-green-100 text-green-600
                                    {% elif log.action == 'EDITED' %}bg-yellow-100 text-yellow-600
                                    {% elif log.action == 'STATUS_CHANGED' %}bg-blue-100 text-blue-600
                                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {% if log.action == 'CREATED' %}‚ûï
                                    {% elif log.action == 'EDITED' %}‚úèÔ∏è
                                    {% elif log.action == 'STATUS_CHANGED' %}üîÑ
                                    {% else %}üìù{% endif %}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">
                                            {% if log.action == 'CREATED' %}Laundry Created
                                            {% elif log.action == 'EDITED' %}Laundry Edited
                                            {% elif log.action == 'STATUS_CHANGED' %}Status Changed
                                            {% else %}{{ log.action|title }}{% endif %}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            by {{ log.user_email }} ‚Ä¢ {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                                        </p>
                                    </div>
                                    {% if log.action in ['EDITED', 'STATUS_CHANGED'] %}
                                    <span class="text-xs px-2 py-1 rounded
                                        {% if log.action == 'EDITED' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                                        {{ log.action|replace('_', ' ')|title }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                {% if log.field_changed %}
                                <div class="mt-2">
                                    <div class="bg-gray-50 rounded p-3 text-xs">
                                        <div class="font-medium text-gray-700 mb-1">{{ log.field_changed|replace('_', ' ')|title }}:</div>
                                        <div class="space-y-1">
                                            {% if log.old_value %}
                                            <div class="text-red-600">
                                                <span class="font-medium">Before:</span> {{ log.old_value }}
                                            </div>
                                            {% endif %}
                                            <div class="text-green-600">
                                                <span class="font-medium">After:</span> {{ log.new_value }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if log.notes %}
                                <div class="mt-2 text-sm text-gray-700">
                                    <strong>Notes:</strong> {{ log.notes }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% else %}
        <div class="p-6 text-center text-gray-500">
            <p class="text-lg font-medium">No audit log entries found for this laundry.</p>
            <p class="text-sm mt-2">this laundry may have been created before the audit logging system was implemented.</p>
            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">Legacy Laundry</h3>
                        <div class="mt-1 text-sm text-yellow-700">
                            <p>Future edits to this laundry will be tracked in the audit log.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Security Notice -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Security & Compliance</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>This audit trail is automatically maintained for all laundry changes to ensure data integrity and compliance. All timestamps are recorded in system time and all changes are tracked by user account.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
