{% extends "base.html" %}

{% block title %}Interactive Charts{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-chart-pie mr-3 text-blue-600"></i>
                    Interactive Charts
                </h1>
                <p class="text-gray-600 mt-2">Visual analytics and business intelligence for your laundry operations</p>
            </div>
            <div class="flex items-center space-x-3">
                <div class="bg-white px-4 py-2 rounded-lg shadow border flex items-center">
                    <i class="fas fa-calendar text-gray-400 mr-2"></i>
                    <span class="text-sm text-gray-600" id="current-date"></span>
                </div>
                <div class="bg-white px-4 py-2 rounded-lg shadow border flex items-center">
                    <i class="fas fa-clock text-gray-400 mr-2"></i>
                    <span class="text-sm font-medium text-gray-800" id="current-time"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Revenue -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                <div class="flex items-center">
                    <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                        <i class="fas fa-peso-sign text-white text-lg"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-blue-100 text-sm font-medium">Total Revenue</p>
                        <p class="text-white text-2xl font-bold">‚Ç±{{ "%.2f"|format(total_revenue) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Laundries -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4">
                <div class="flex items-center">
                    <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                        <i class="fas fa-tshirt text-white text-lg"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-orange-100 text-sm font-medium">Active Laundries</p>
                        <p class="text-white text-2xl font-bold">{{ active_laundries }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Customers -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4">
                <div class="flex items-center">
                    <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                        <i class="fas fa-users text-white text-lg"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-green-100 text-sm font-medium">Total Customers</p>
                        <p class="text-white text-2xl font-bold">{{ total_customers }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Value -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
                <div class="flex items-center">
                    <div class="p-2 bg-white bg-opacity-20 rounded-lg">
                        <i class="fas fa-boxes text-white text-lg"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-purple-100 text-sm font-medium">Inventory Value</p>
                        <p class="text-white text-2xl font-bold">‚Ç±{{ "%.2f"|format(total_inventory_value or 0) }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Trends Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-chart-line mr-3"></i>
                    Revenue Trends
                </h2>
                <p class="text-blue-100 mt-1">Monthly revenue progression</p>
            </div>
            <div class="p-6">
                <canvas id="revenueChart" height="300"></canvas>
            </div>
        </div>

        <!-- Service Distribution Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-chart-pie mr-3"></i>
                    Service Distribution
                </h2>
                <p class="text-green-100 mt-1">Service type breakdown</p>
            </div>
            <div class="p-6">
                <canvas id="serviceChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Additional Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Laundry Status Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-chart-donut mr-3"></i>
                    Laundry Status Distribution
                </h2>
                <p class="text-amber-100 mt-1">Current laundry statuses</p>
            </div>
            <div class="p-6">
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>

        <!-- Inventory Levels Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Inventory Levels
                </h2>
                <p class="text-purple-100 mt-1">Stock management overview</p>
            </div>
            <div class="p-6">
                <canvas id="inventoryChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Extended Analytics Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Monthly Revenue Comparison -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-teal-500 to-cyan-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-chart-area mr-3"></i>
                    Monthly Revenue Analysis
                </h2>
                <p class="text-teal-100 mt-1">Year-to-date revenue trends</p>
            </div>
            <div class="p-6">
                <canvas id="monthlyRevenueChart" height="300"></canvas>
            </div>
        </div>

        <!-- Customer Growth Chart -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-rose-500 to-pink-600 px-6 py-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-user-plus mr-3"></i>
                    Customer Growth
                </h2>
                <p class="text-rose-100 mt-1">Quarterly customer acquisition</p>
            </div>
            <div class="p-6">
                <canvas id="customerGrowthChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Analytics Insights Section -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-lightbulb mr-3"></i>
                Analytics Insights
            </h2>
            <p class="text-indigo-100 mt-1">Key performance insights and recommendations</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Revenue Insight -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-trending-up text-white"></i>
                        </div>
                        <h3 class="ml-3 font-semibold text-gray-800">Revenue Performance</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        Your average revenue per customer is <strong>‚Ç±{{ "%.2f"|format((total_revenue / total_customers) if total_customers > 0 else 0) }}</strong>
                    </p>
                    <div class="text-xs text-blue-600 font-medium">
                        {% if total_revenue > 10000 %}
                        üìà Excellent performance! Keep it up!
                        {% elif total_revenue > 5000 %}
                        üìä Good revenue growth. Consider upselling services.
                        {% else %}
                        üí° Focus on customer acquisition and retention.
                        {% endif %}
                    </div>
                </div>

                <!-- Laundry Management -->
                <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-4 border border-orange-100">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clipboard-list text-white"></i>
                        </div>
                        <h3 class="ml-3 font-semibold text-gray-800">Laundry Management</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        You have <strong>{{ active_laundries }}</strong> active laundries out of <strong>{{ active_laundries + completed_laundries }}</strong> total
                    </p>
                    <div class="text-xs text-orange-600 font-medium">
                        {% if active_laundries > completed_laundries %}
                        ‚è∞ High volume period. Ensure timely completion.
                        {% elif active_laundries > 0 %}
                        ‚úÖ Good laundry flow. Maintain service quality.
                        {% else %}
                        üéØ Ready for new laundries. Consider marketing.
                        {% endif %}
                    </div>
                </div>

                <!-- Inventory Insight -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-boxes text-white"></i>
                        </div>
                        <h3 class="ml-3 font-semibold text-gray-800">Inventory Health</h3>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        <strong>{{ low_stock_items_count or 0 }}</strong> items are low on stock, <strong>{{ out_of_stock_items_count or 0 }}</strong> out of stock
                    </p>
                    <div class="text-xs text-green-600 font-medium">
                        {% if low_stock_items_count > 5 %}
                        üì¶ Consider restocking soon to avoid shortages.
                        {% elif out_of_stock_items_count > 0 %}
                        ‚ö†Ô∏è Restock out-of-stock items immediately.
                        {% else %}
                        ‚ú® Inventory levels are healthy!
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-download mr-3"></i>
                Export & Share
            </h2>
            <p class="text-gray-200 mt-1">Download charts and share insights</p>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap gap-4">
                <button onclick="exportChart('revenue')" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>
                    Export Revenue Chart
                </button>
                <button onclick="exportChart('services')" class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-chart-pie mr-2"></i>
                    Export Service Chart
                </button>
                <button onclick="exportAllCharts()" class="flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-file-export mr-2"></i>
                    Export All Charts
                </button>
                <button onclick="printCharts()" class="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-print mr-2"></i>
                    Print Charts
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Spacing -->
    <div class="h-16"></div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart Data -->
<script id="chart-data" type="application/json">{{ chart_data | tojson }}</script>

<script>
// Initialize Interactive Charts
document.addEventListener('DOMContentLoaded', function() {
    // Get chart data from backend
    const chartDataScript = document.getElementById('chart-data');
    const chartData = JSON.parse(chartDataScript.textContent);
    
    // Store chart instances for export functionality
    window.chartInstances = {};
    
    // Revenue Trends Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    window.chartInstances.revenue = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: chartData.revenue.labels,
            datasets: [{
                label: 'Revenue (‚Ç±)',
                data: chartData.revenue.data,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgb(59, 130, 246)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç±' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Service Distribution Chart
    const serviceCtx = document.getElementById('serviceChart').getContext('2d');
    window.chartInstances.services = new Chart(serviceCtx, {
        type: 'doughnut',
        data: {
            labels: chartData.services.labels,
            datasets: [{
                data: chartData.services.data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderWidth: 3,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Laundry Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    window.chartInstances.status = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: chartData.status.labels,
            datasets: [{
                data: chartData.status.data,
                backgroundColor: [
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(139, 69, 19, 0.8)'
                ],
                borderWidth: 3,
                borderColor: 'white'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Inventory Levels Chart
    const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
    window.chartInstances.inventory = new Chart(inventoryCtx, {
        type: 'bar',
        data: {
            labels: chartData.inventory.labels,
            datasets: [{
                label: 'Items',
                data: chartData.inventory.data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(16, 185, 129, 0.8)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(245, 158, 11)',
                    'rgb(239, 68, 68)',
                    'rgb(16, 185, 129)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Monthly Revenue Chart
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    window.chartInstances.monthlyRevenue = new Chart(monthlyRevenueCtx, {
        type: 'bar',
        data: {
            labels: chartData.monthly_revenue.labels,
            datasets: [{
                label: 'Monthly Revenue (‚Ç±)',
                data: chartData.monthly_revenue.data,
                backgroundColor: 'rgba(20, 184, 166, 0.8)',
                borderColor: 'rgb(20, 184, 166)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç±' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Customer Growth Chart
    const customerGrowthCtx = document.getElementById('customerGrowthChart').getContext('2d');
    window.chartInstances.customerGrowth = new Chart(customerGrowthCtx, {
        type: 'line',
        data: {
            labels: chartData.customer_growth.labels,
            datasets: [{
                label: 'Customers',
                data: chartData.customer_growth.data,
                borderColor: 'rgb(236, 72, 153)',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgb(236, 72, 153)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});

// Real-time clock and date
function updateDateTime() {
    const now = new Date();
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    };
    const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    
    const timeElement = document.getElementById('current-time');
    const dateElement = document.getElementById('current-date');
    
    if (timeElement && dateElement) {
        timeElement.textContent = now.toLocaleTimeString('en-US', timeOptions);
        dateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
    }
}

// Update time every second
setInterval(updateDateTime, 1000);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDateTime();
});

// Export functionality
function exportChart(chartName) {
    if (window.chartInstances && window.chartInstances[chartName]) {
        const chart = window.chartInstances[chartName];
        const url = chart.toBase64Image();
        const link = document.createElement('a');
        link.download = `${chartName}-chart.png`;
        link.href = url;
        link.click();
    }
}

function exportAllCharts() {
    Object.keys(window.chartInstances).forEach(chartName => {
        setTimeout(() => exportChart(chartName), 100);
    });
}

function printCharts() {
    window.print();
}
</script>

{% endblock %}
