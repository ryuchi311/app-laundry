{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto py-8">
  <h1 class="text-2xl font-bold mb-4">Customer Directory</h1>
  <div class="mb-4">
    <input id="searchInput" type="text" placeholder="Search customers..." class="border rounded px-3 py-2 w-full" />
  </div>
  <div id="loader" class="flex justify-center items-center py-8 hidden">
    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span class="ml-2 text-blue-500">Loading...</span>
  </div>
  <div id="customerTableWrapper">
    <!-- Table will be loaded here -->
  </div>
  <div id="paginationWrapper" class="mt-4 flex justify-center"></div>
</div>
<script>
const apiUrl = '/api/customers';
let currentPage = 1;
let perPage = 25;
let currentSearch = '';

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'flex' : 'none';
}

function fetchCustomers(page = 1, search = '') {
  showLoader(true);
  fetch(`${apiUrl}?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`)
    .then(res => res.json())
    .then(data => {
      renderTable(data.results);
      renderPagination(data.page, data.pages);
      showLoader(false);
    });
}

function renderTable(customers) {
  let html = `<table class="min-w-full bg-white border rounded shadow">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4 border-b">ID</th>
        <th class="py-2 px-4 border-b">Full Name</th>
        <th class="py-2 px-4 border-b">Email</th>
        <th class="py-2 px-4 border-b">Phone</th>
        <th class="py-2 px-4 border-b">Active</th>
        <th class="py-2 px-4 border-b">Date Created</th>
      </tr>
    </thead>
    <tbody>`;
  if (customers.length === 0) {
    html += `<tr><td colspan="6" class="text-center py-4">No customers found.</td></tr>`;
  } else {
    customers.forEach(c => {
      html += `<tr>
        <td class="py-2 px-4 border-b">${c.id}</td>
        <td class="py-2 px-4 border-b">${c.full_name}</td>
        <td class="py-2 px-4 border-b">${c.email}</td>
        <td class="py-2 px-4 border-b">${c.phone}</td>
        <td class="py-2 px-4 border-b">${c.is_active ? 'Yes' : 'No'}</td>
        <td class="py-2 px-4 border-b">${c.date_created}</td>
      </tr>`;
    });
  }
  html += '</tbody></table>';
  document.getElementById('customerTableWrapper').innerHTML = html;
}

function renderPagination(page, totalPages) {
  let html = '';
  if (totalPages > 1) {
    html += `<nav class="inline-flex">`;
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="px-3 py-1 mx-1 rounded ${i === page ? 'bg-blue-500 text-white' : 'bg-gray-200'}" onclick="goToPage(${i})">${i}</button>`;
    }
    html += `</nav>`;
  }
  document.getElementById('paginationWrapper').innerHTML = html;
}

function goToPage(page) {
  currentPage = page;
  fetchCustomers(currentPage, currentSearch);
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  currentSearch = e.target.value;
  currentPage = 1;
  fetchCustomers(currentPage, currentSearch);
});

// Initial load
fetchCustomers();
</script>
{% endblock %}
