{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto py-8">
  <h1 class="text-2xl font-bold mb-4">Customer List View</h1>
  <div class="mb-4">
    <input id="searchInput" type="text" placeholder="Search by name..." class="border rounded px-3 py-2 w-full" />
  </div>
  <div id="loader" class="flex justify-center items-center py-8 hidden">
    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span class="ml-2 text-blue-500">Loading...</span>
  </div>
  <ul id="customerList" class="bg-white border rounded shadow divide-y divide-gray-100"></ul>
  <div id="paginationWrapper" class="mt-4 flex justify-center"></div>
</div>
<script>
const apiUrl = '/api/customers';
let currentPage = 1;
let perPage = 25;
let currentSearch = '';

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'flex' : 'none';
}

function fetchCustomers(page = 1, search = '') {
  showLoader(true);
  fetch(`${apiUrl}?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`)
    .then(res => res.json())
    .then(data => {
      renderList(data.results);
      renderPagination(data.page, data.pages);
      showLoader(false);
    });
}

function renderList(customers) {
  let html = '';
  if (customers.length === 0) {
    html = `<li class="py-4 text-center text-gray-500">No customers found.</li>`;
  } else {
    customers.forEach(c => {
      html += `<li class="py-4 px-4 flex flex-col md:flex-row md:items-center justify-between">
        <div class="flex-1">
          <span class="font-semibold text-lg text-gray-800">${c.full_name}</span>
          <span class="ml-2 text-gray-500">(${c.email})</span>
        </div>
        <div class="flex flex-col md:flex-row md:items-center gap-2 mt-2 md:mt-0">
          <span class="text-gray-600">${c.phone}</span>
          <span class="px-2 py-1 rounded ${c.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${c.is_active ? 'Active' : 'Inactive'}</span>
          <span class="text-xs text-gray-400">${c.date_created}</span>
        </div>
      </li>`;
    });
  }
  document.getElementById('customerList').innerHTML = html;
}

function renderPagination(page, totalPages) {
  let html = '';
  if (totalPages > 1) {
    html += `<nav class="inline-flex">`;
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="px-3 py-1 mx-1 rounded ${i === page ? 'bg-blue-500 text-white' : 'bg-gray-200'}" onclick="goToPage(${i})">${i}</button>`;
    }
    html += `</nav>`;
  }
  document.getElementById('paginationWrapper').innerHTML = html;
}

function goToPage(page) {
  currentPage = page;
  fetchCustomers(currentPage, currentSearch);
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  currentSearch = e.target.value;
  currentPage = 1;
  fetchCustomers(currentPage, currentSearch);
});

// Initial load
fetchCustomers();
</script>
{% endblock %}
